# REST Api Documentation

## Authentication & Authorization 

### Open Api Documentation
For more information on available calls and messages structure [goto the open api docs](./accounts/open-api)

Authentication and authorization is achieved using [JSON web tokens](https://jwt.io/). A token can be be obtained in 3 ways:

### Username & Password

By default when a user is created a password request will be sent to the user via email. Once a password has been set a user can use that password to authenticate against the api.

```
POST /account/auth

{
    "username": "string",
    "password": "string"
}
```

### Username & Pin

When a pin has been set a user can use the pin in place of their password. The same api call can be used as per above.

```
POST /account/auth

{
    "username": "string",
    "password": "string"
}
```

### Api Key

For integrations an api key can be created which will allow you to limit access for that integration to only the relevant integration api's. A token can be obtained using an API key as follows:

```
GET /account/auth?apiKeyId=string
```

#### Obtaining an Api key

Api keys are generated from the organisation module via [the web application](http://app.trackmatic.co.za). Organisation administrator rights are required in order to do this. If you do not have administrator rights you will need to ask your organisation administrator to do this on your behalf. An api key is assigned permissions in a similar fashion to a user. Modules, roles and sites are allocated to the api key to allow access to the necessary areas. Generally there will be a specific `Integration` role which will provide access to the specific integration apis, however it is possible to allocate additional permissions to an api key which will give it the same access level as a normal user.

### Authorization Header

Once a valid token has been obtained it must be attached to each subsequent request with the HTTP authorization header in the following format:

```
Authorization: Bearer [token]
```

> Note: The token must be prefixed by "Bearer "

### Token Expiration

Tokens expire after a predefined amount of time and will need to be refereshed using your password, pin or api key. For integrations it is recommended that a new token is obtained for each session or unit of work which is performed.

### Refreshing Tokens

It is possible for certain actions to cause a token to be invalidated. When this happens the API will return an updated token in the Authorization header of the response. This updated token should be used for any subsequent requests being performed agains the api.

## Schema

All API access is over HTTPS, and accessed from `https://rest.trackmatic.co.za/api/v2`. All data is sent and received as JSON.

## Hypermedia

All responses are wrapped in an envelope which contains metadata about the data being returned.

### Collections

When collections of items are returned they will usually be returned as a paginated list. Pagination metadata is contained in the `pagination` section of the envelope as shown below. The `data` element of the response will contain the data which corresponds to the current page.

```
{
    "pagination": {
        "page_size": 0,
        "page_no": 0,
        "total": 0
    },
    "data": [
        ...
    ]
}
``` 

### Single resource

When returning data for a single resource it takes the following form:

``` 
{
    "data": { ... },
    "links": [{
        "href": "https://...",
        "rel": "..."
    }, ...]
    ...
}
```

## HTTP Methods

HTTP methods are used as per the below table.

| Method | Usage | Idempotent | Notes |
| ---    | ---   | ---        | ---   |
| POST   | Create|| Create a new resource |
| PUT    | Update|X| Update an entire resource |
| PATCH  | Update|X| Update a partial resource |
| DELETE | Delete|| Delete an existing resource |
| GET    | Read |X| Retrieve data |

## Errors

Errors are returned using an appropriate HTTP error code. Some common error codes returned are as follows:

- 401 - Unauthorized (Authentication error)
- 403 - Forbidden (Authorization error)
- 400 - Bad request (Validation errors)

### Error responses

When returning an error code it is accompanied by an explanation of the error in the response body. The repsonse content takes the following form:

```
[{
    "message": "string",
    "type": "string", (optional)
    "code": "string", (optional)
    "key": "string" (optional)
}]
```

- Message - Contains the error message generated by the server
- Type - Indicates the specific type of error e.g. Validation, Format
- Code - A unique error code which represents the error being generated
- Key - Used to link the error to a specific field. Can be used for validation responses.

> Note - The response is always an array of error messages

## Timezones

All date-time values MUST be provided as ISO 8601 UTC date-times and all responses are in the same format.

## Time spans

Time spans (Durations) are represents in the ASP.NET style time spans

```
1.23:59:59.999 [days.hours:minutes:seconds:milliseconds]
```

Shorter representations can be used when days and milliseconds are not applicable as follows:

```
23:59:59 [hours:minutes:seconds]
```

## Geospatial Coordinates

GPS coordinates are represented by an array of float values where the first item is the longitude and the second value is the latitude `[longitude, latitude]`. Each item in the array is in the decimal degrees (DD) format. See [GEOJson RFC](https://tools.ietf.org/html/rfc7946#section-3.1.1) for further details.